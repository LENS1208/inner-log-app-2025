<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>デバッグテスト</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .result { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; }
    .error { background: #fee; color: #c00; }
    .success { background: #efe; color: #060; }
    button { padding: 10px 20px; margin: 5px; background: #0084c7; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <h1>デバッグテスト</h1>

  <div class="test">
    <h2>1. 環境変数チェック</h2>
    <button onclick="testEnv()">テスト実行</button>
    <div id="env-result" class="result"></div>
  </div>

  <div class="test">
    <h2>2. 認証状態チェック</h2>
    <button onclick="testAuth()">テスト実行</button>
    <div id="auth-result" class="result"></div>
  </div>

  <div class="test">
    <h2>3. データベース接続チェック</h2>
    <button onclick="testDB()">テスト実行</button>
    <div id="db-result" class="result"></div>
  </div>

  <div class="test">
    <h2>4. ログアウトテスト</h2>
    <button onclick="testLogout()">ログアウト実行</button>
    <div id="logout-result" class="result"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabaseUrl = import.meta.env?.VITE_SUPABASE_URL ||
                        localStorage.getItem('supabase.url') ||
                        prompt('SUPABASE_URL を入力してください');

    const supabaseKey = import.meta.env?.VITE_SUPABASE_ANON_KEY ||
                        localStorage.getItem('supabase.key') ||
                        prompt('SUPABASE_ANON_KEY を入力してください');

    if (supabaseUrl && supabaseKey) {
      localStorage.setItem('supabase.url', supabaseUrl);
      localStorage.setItem('supabase.key', supabaseKey);
    }

    const supabase = createClient(supabaseUrl, supabaseKey);

    window.testEnv = () => {
      const result = document.getElementById('env-result');
      result.className = 'result';
      result.textContent = `URL: ${supabaseUrl ? '✅ 設定済み' : '❌ 未設定'}\nKey: ${supabaseKey ? '✅ 設定済み' : '❌ 未設定'}`;
      result.className = `result ${supabaseUrl && supabaseKey ? 'success' : 'error'}`;
    };

    window.testAuth = async () => {
      const result = document.getElementById('auth-result');
      result.textContent = '確認中...';
      result.className = 'result';

      try {
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error) throw error;

        if (session?.user) {
          result.textContent = `✅ ログイン済み\nEmail: ${session.user.email}\nUser ID: ${session.user.id}`;
          result.className = 'result success';
        } else {
          result.textContent = '❌ ログインしていません';
          result.className = 'result error';
        }
      } catch (err) {
        result.textContent = `❌ エラー: ${err.message}`;
        result.className = 'result error';
      }
    };

    window.testDB = async () => {
      const result = document.getElementById('db-result');
      result.textContent = '確認中...';
      result.className = 'result';

      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          result.textContent = '❌ ログインが必要です';
          result.className = 'result error';
          return;
        }

        // user_settings取得テスト
        const { data: settings, error: settingsError } = await supabase
          .from('user_settings')
          .select('*')
          .eq('user_id', user.id)
          .maybeSingle();

        if (settingsError) throw settingsError;

        // trades取得テスト
        const { data: trades, error: tradesError } = await supabase
          .from('trades')
          .select('count')
          .eq('user_id', user.id);

        if (tradesError) throw tradesError;

        result.textContent = `✅ データベース接続成功\n\nuser_settings: ${settings ? '存在する' : '存在しない'}\ntrades: ${trades?.length || 0}件`;
        result.className = 'result success';
      } catch (err) {
        result.textContent = `❌ エラー: ${err.message}\n\n詳細: ${JSON.stringify(err, null, 2)}`;
        result.className = 'result error';
      }
    };

    window.testLogout = async () => {
      const result = document.getElementById('logout-result');
      result.textContent = 'ログアウト中...';
      result.className = 'result';

      try {
        const { error } = await supabase.auth.signOut();

        if (error) throw error;

        result.textContent = '✅ ログアウト成功';
        result.className = 'result success';

        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } catch (err) {
        result.textContent = `❌ エラー: ${err.message}`;
        result.className = 'result error';
      }
    };

    // 自動実行
    window.addEventListener('load', () => {
      testEnv();
      testAuth();
    });
  </script>
</body>
</html>
