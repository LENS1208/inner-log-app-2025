# トレード詳細ページ 機能仕様書

## 概要
取引一覧からリンクされる個別トレードの詳細情報・日記入力ページ。
トレードの詳細情報表示とトレード日記（振り返り・分析）の記録が可能。

---

## 実装ファイル
- **メインコンポーネント**: `src/components/trade/TradeDetailPanel.tsx`
- **親ページ**: `src/widgets/TradeDiaryPage.tsx`（取引一覧から遷移）
- **データベーステーブル**: `trade_notes`（トレード日記データ）、`trades`（トレードデータ）
- **スタイル**: `src/tradeDiary.css`

---

## データ構造

### TradeData（取引基本情報）
```typescript
{
  ticket: string;          // チケット番号（一意）
  item: string;            // 通貨ペア（例: GBPJPY）
  side: 'BUY' | 'SELL';   // ポジション方向
  size: number;            // ロットサイズ
  openTime: Date;          // エントリー時刻
  openPrice: number;       // エントリー価格
  closeTime: Date;         // 決済時刻
  closePrice: number;      // 決済価格
  commission: number;      // 手数料
  swap: number;            // スワップポイント
  profit: number;          // 損益（円）
  pips: number;            // pips
  sl: number | null;       // ストップロス価格
  tp: number | null;       // テイクプロフィット価格
}
```

### TradeKpi（KPI表示用）
```typescript
{
  net: number;             // 純損益（円）
  pips: number;            // 獲得pips
  hold: number;            // 保有時間（ミリ秒）
  gross: number;           // 総利益
  cost: number;            // 総コスト
  rrr: number | null;      // リスクリワード比
}
```

### TradeNote（データベース保存内容）
```typescript
{
  ticket: string;                    // チケット番号
  entry_emotion: string;             // エントリー時の感情
  entry_basis: string[];             // エントリー根拠（最大2つ）
  tech_set: string[];                // テクニカル条件（最大2つ）
  market_set: string[];              // マーケット環境（最大2つ）
  fund_set: string[];                // ファンダメンタルズ（最大2つ）
  fund_note: string;                 // エントリー前の自由メモ
  exit_triggers: string[];           // 決済のきっかけ（最大2つ）
  exit_emotion: string;              // 決済時の感情
  note_right: string;                // うまくいった点
  note_wrong: string;                // 改善点
  note_next: string;                 // 次回の約束
  note_free: string;                 // 決済後の自由メモ
  tags: string[];                    // タグ
  images: string[];                  // 画像URL配列
  ai_advice: string;                 // AIアドバイス
  ai_advice_pinned: boolean;         // AIアドバイスピン留め
}
```

---

## 画面構成

### 1. ヘッダー部分
- **タイトル**: 「取引ノート」
- **ボタン**:
  - **詳細ページへ →**: ノートブック形式の詳細ページに遷移
  - **メニュー（⋮）**:
    - 日次ノートにリンク（未実装）
    - 関連メモを表示（未実装）
    - ノートを削除（実装済み）

### 2. KPIカード（4枚）
- **損益（円）**: 利益/損失を色分け表示（赤/緑）
- **pips**: 獲得pips数を色分け表示
- **保有時間**: 時間と分で表示（例: 27時間34分）
- **リスクリワード比（RRR）**: 小数点2桁

### 3. 取引情報（2列グリッド）
- 通貨ペア
- ポジション（買い/売り）
- サイズ（lot）
- 指値/逆指値
- エントリー価格＜時刻＞
- 決済価格＜時刻＞

### 4. 取引日記セクション

#### A. エントリー前・直後
**基本入力**:
- 自由メモ（textarea）: エントリー判断の理由やニュース情報など

**詳細展開項目**（「詳細を開く」ボタンで表示）:
- **エントリー時の感情**（select）:
  - 落ち着いていた
  - 自信あり
  - 少し焦っていた
  - なんとなく
  - 負けを取り返したい
  - 迷いがある
  - 置いていかれ不安

- **エントリー根拠**（MultiSelect、最大2つ）:
  - 押し目・戻り
  - ブレイク
  - ダブルトップ／ダブルボトム
  - 三角持ち合い／ペナント／フラッグ
  - チャネル反発／上限・下限タッチ
  - だまし（フェイク）
  - ピンバー／包み足／はらみ足
  - フィボ反発（38.2／50／61.8)

- **テクニカル条件**（MultiSelect、最大2つ）:
  - MAクロス（ゴールデン／デッド）
  - ボリンジャー（±2σタッチ→内戻り）
  - RSI 50回復／割れ
  - RSI 過熱（70↑）／逆張り（30↓）
  - 一目均衡表合致（雲反発／雲抜け／三役）
  - MACDクロス（上向き／下向き）
  - フィボ合致（38.2／50／61.8）
  - ピボット（R1／R2／S1／S2）
  - ATR 高め／低め
  - ADX 強め／弱め

- **マーケット環境**（MultiSelect、最大2つ）:
  - トレンド相場
  - レンジ相場
  - 市場オープン切替（東京→欧州／欧州→NY）
  - ボラ高め
  - ボラ低め
  - 高値圏
  - 安値圏
  - 薄商い
  - オプションバリア付近
  - ニュース直後
  - 指標前

- **ファンダメンタルズ**（MultiSelect、最大2つ）:
  - 金利見通し
  - 中銀スタンス
  - 景気サプライズ
  - インフレ圧力
  - リスクオン・リスクオフ
  - 原油・商品
  - ポジション偏り
  - 地政学ヘッドライン

- **AIの予想**:
  - AIのポジション予測（select）: 買い／売り／様子見
  - 取引の判断（select）: 従った／一部従った／従わなかった

#### B. ポジション保有中
**基本入力**:
- 自由メモ（textarea）: 保有中の気づきや感想

**詳細展開項目**:
- **保有中の感情**（MultiSelect、最大2つ）:
  - 余裕があった
  - 不安が増えた
  - 早く逃げたい
  - 欲が出た
  - 含み益に固執
  - 含み損に耐えた
  - 判断がぶれた
  - 集中が切れた
  - 予定通りに待てた

- **事前ルール**（MultiSelect、最大2つ）:
  - 逆指値は必ず置く
  - 損切り幅を固定
  - 直近足の下/上に損切り
  - 分割エントリー
  - 分割利確
  - トレーリング
  - 指標またぎ回避
  - 1日の取引は◯回まで

- **ルールの守り具合**（select）:
  - しっかり守れた
  - 一部守れなかった
  - 守れなかった

#### C. ポジション決済後
**基本入力**:
- 自由メモ（textarea）: 決済後の振り返り全般

**詳細展開項目**:
- **決済のきっかけ**（MultiSelect、最大2つ）:
  - 目標価格に到達
  - 逆指値に到達（損切り）
  - 想定価格に達した（部分／全）
  - 損益表示に影響された
  - 指標が近づいた
  - ボラ急変
  - 形状が崩れた
  - 時間切れ（ルール時間）
  - AIシグナル終了／反転
  - ほかのセットアップ優先

- **決済時の感情**（select）:
  - 予定通りで満足
  - 早く手放したい
  - もっと引っ張れた
  - 怖くなった
  - 安堵した
  - 悔しい
  - 反省している

- **当たり外れ（AI）**（select）:
  - 当たり
  - 惜しい
  - 外れ

- **AI予想が良かった点**（MultiSelect、最大2つ）:
  - ポジションの精度
  - エントリーのタイミング
  - 利確＆損切りライン
  - 根拠が分かりやすい

- **うまくいった点**（textarea）
- **改善点**（textarea）
- **次回の約束**（textarea）

### 5. 画像セクション
- **機能**:
  - 画像アップロード（最大3ファイル、1ファイル3MBまで）
  - 対応形式: .jpg, .jpeg, .gif, .png
  - サムネイル表示
  - クリックでプレビュー拡大表示
  - 個別削除機能

### 6. タグセクション
- **機能**:
  - タグ追加モーダル
  - プリセットタグ（10種類）:
    - デイトレ
    - スイング
    - 順張り
    - 逆張り
    - 成功
    - 失敗
    - ルール遵守
    - ルール違反
    - 感情的
    - 冷静
  - タグクリックで削除

### 7. 保存ボタン
- ページ上部と下部の2箇所に配置
- データベースへの保存処理
- トースト通知（成功/失敗）

---

## 主要機能

### 1. データ永続化
- **保存先**: Supabaseデータベース `trade_notes` テーブル
- **保存タイミング**: ユーザーが「保存」ボタンをクリック
- **自動読み込み**: ページ表示時に既存ノートを自動取得

### 2. MultiSelect コンポーネント
- 最大2つまで選択可能
- チェックボックス形式
- 選択済み項目は常に選択可能（解除のため）
- 未選択項目は最大数に達すると無効化

### 3. 画像管理
- Base64エンコードでローカル保存
- プレビュー機能
- 削除時に確認ダイアログ表示

### 4. 詳細展開/折りたたみ
- 3つのセクションそれぞれで独立して展開/折りたたみ可能
- 初期状態は折りたたみ

### 5. ノート削除機能
- メニューから実行
- 確認ダイアログ表示
- localStorage から削除（現状）
  - ※今後データベース対応が必要

---

## データベーススキーマ

### trade_notes テーブル
```sql
CREATE TABLE trade_notes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket text UNIQUE NOT NULL REFERENCES trades(ticket) ON DELETE CASCADE,
  entry_emotion text DEFAULT '',
  entry_basis jsonb DEFAULT '[]',
  tech_set jsonb DEFAULT '[]',
  market_set jsonb DEFAULT '[]',
  fund_set jsonb DEFAULT '[]',
  fund_note text DEFAULT '',
  exit_triggers jsonb DEFAULT '[]',
  exit_emotion text DEFAULT '',
  note_right text DEFAULT '',
  note_wrong text DEFAULT '',
  note_next text DEFAULT '',
  note_free text DEFAULT '',
  tags jsonb DEFAULT '[]',
  images jsonb DEFAULT '[]',
  ai_advice text DEFAULT '',
  ai_advice_pinned boolean DEFAULT false,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### インデックス
- `idx_trade_notes_ticket ON trade_notes(ticket)`

---

## UI/UXの特徴

### デザイン
- カード型レイアウト
- ダークモード対応（CSS変数使用）
- レスポンシブデザイン
- 2列グリッド（取引情報、KPIカード）

### 操作性
- 段階的な情報開示（詳細展開ボタン）
- 直感的なタグ管理
- ドラッグ&ドロップ非対応（ファイル選択のみ）
- モーダルによる追加入力

### フィードバック
- トースト通知（保存成功/失敗）
- ローディング状態表示
- エラーメッセージ表示

---

## 未実装機能・TODO

### 1. 関連機能（メニュー項目）
- [ ] 日次ノートへのリンク機能
- [ ] 関連メモ表示機能

### 2. AI関連
- [ ] AIアドバイスの自動生成
- [ ] AIアドバイスのピン留め機能

### 3. データ管理
- [ ] ノート削除のデータベース対応（現状localStorage）
- [ ] 画像のストレージ保存（現状Base64）

### 4. 分析・集計
- [ ] タグ別の取引分析
- [ ] エントリー根拠別の勝率分析
- [ ] 感情パターンと損益の相関分析

### 5. UX改善
- [ ] 下書き保存機能
- [ ] 入力内容の自動保存
- [ ] テンプレート機能
- [ ] コピー機能（別のトレードへのコピー）

---

## 技術的詳細

### 依存関係
- React
- Supabase Client
- Chart.js（親コンポーネントで使用）
- カスタムトースト通知システム

### 状態管理
- React Hooks（useState, useEffect, useCallback）
- ローカル状態のみ（グローバル状態管理不使用）

### パフォーマンス考慮
- useCallback でイベントハンドラーをメモ化
- クリックアウトサイドの適切なクリーンアップ

---

## 設計思想

### 1. 柔軟性
- 自由記述とプリセット選択のバランス
- 段階的な詳細入力（必須項目なし）

### 2. 振り返り重視
- エントリー前・保有中・決済後の3段階記録
- 感情・ルール遵守・根拠の明確化

### 3. データ分析基盤
- 構造化データ（MultiSelect）による後続分析の容易さ
- タグによる柔軟な分類

### 4. トレーダー心理
- 感情の記録を重視
- ルール遵守の自己評価
- 次回への改善アクション明記

---

## 利用シーン

1. **取引直後**: 感情や判断理由が鮮明なうちにクイック記録
2. **日次振り返り**: チャート画像を添付して詳細分析
3. **週次レビュー**: タグで分類した取引の傾向分析
4. **月次分析**: うまくいった点・改善点の集計

---

## 関連ページ・機能

- **取引一覧ページ** (`TradeListPage`): このページへの遷移元
- **ノートブック詳細ページ** (`/notebook/:id`): より詳細な編集画面
- **日次ノートページ** (`DailyNotePage`): 日ごとの振り返り
- **月次レビューページ** (`MonthlyReviewPage`): 月ごとの統計分析

---

## メンテナンス情報

- **最終更新**: 2025-12-02
- **コンポーネント場所**: `src/components/trade/TradeDetailPanel.tsx`
- **主要依存**: `db.service.ts`, `chartColors.ts`, `toast.ts`
- **スタイル**: `src/tradeDiary.css`

---

この仕様書は、別のAIや開発者がこのページの機能を理解し、ブラッシュアップや機能追加を行う際の参考資料として活用できます。
