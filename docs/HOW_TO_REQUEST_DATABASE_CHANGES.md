# データベース変更リクエストガイド

**最終更新**: 2025-11-25

このドキュメントは、AIアシスタントにデータベース変更を依頼する際の効果的なリクエスト方法を説明します。

---

## 🎯 基本原則

### 明確に伝えるべき3つのポイント

1. **何を変更したいか** - テーブル、カラム、RLS等の具体的な対象
2. **なぜ変更が必要か** - 機能要件やビジネスロジック
3. **データへの影響** - 既存データの扱い方

---

## ✅ 良いリクエスト例

### 例1: 新しいテーブルを追加

```
✅ 良い例：
「トレード設定を保存するための新しいテーブルを作成してください。
以下のカラムが必要です：
- id (uuid, primary key)
- user_id (uuid, 外部キー to auth.users)
- setup_name (text, 必須) - 例: "Breakout", "Reversal"
- description (text, オプション)
- created_at (timestamp)

各ユーザーが自分の設定のみ読み書きできるようにRLSを設定してください。
既存データへの影響はありません。」

❌ 悪い例：
「設定テーブルを作って」
```

**良い点**:
- テーブルの目的が明確
- 全カラムの型と制約を指定
- RLSの要件を明示
- 既存データへの影響を確認

### 例2: 既存テーブルにカラムを追加

```
✅ 良い例：
「tradesテーブルに"risk_reward_ratio"カラムを追加してください。
- 型: numeric
- NULL許可
- デフォルト値: NULL
- 説明: リスクリワード比（TP/SL の比率）

既存のトレードデータは約500件ありますが、
このカラムはNULLのままで問題ありません。
後から手動で計算して入力します。」

❌ 悪い例：
「tradesにリスクリワード比を追加して」
```

**良い点**:
- カラムの詳細な仕様
- 既存データの件数と扱い方を明示
- 後続の作業計画を共有

### 例3: RLSポリシーの変更

```
✅ 良い例：
「ai_proposalsテーブルのRLSポリシーを確認してください。
現在、自分のデータのみ参照できるようになっていますが、
parent_idで紐づく提案も参照できるようにしたいです。

具体的には：
- 自分が作成した提案（user_id = auth.uid()）
- 自分の提案の子提案（parent.user_id = auth.uid()）

既存のINSERT/UPDATE/DELETEポリシーは変更不要です。」

❌ 悪い例：
「親の提案も見れるようにして」
```

**良い点**:
- 現在の状態と変更後の状態を明確に説明
- 変更が必要なポリシーと不要なポリシーを区別
- データアクセスのロジックを具体的に記述

### 例4: デモデータの更新

```
✅ 良い例：
「デモデータ（Dataset A）に新しいセットアップを追加したいです。
/public/demo/A.csv を編集して、以下の10件のトレードを追加：
[具体的なトレードデータのリスト]

マイグレーションは変更しないでください。
追加後、npm run validate:demo を実行して検証してください。」

❌ 悪い例：
「デモデータに取引を追加して」
```

**良い点**:
- CSVファイルを指定
- マイグレーション不要を明示
- 検証手順を指示

---

## ⚠️ 特に注意が必要な変更

### 1. 既存カラムの型変更

```
✅ リクエスト時に必ず含めること：
- 現在のデータ型と新しいデータ型
- 既存データの件数
- データ変換の方法
- 変換できないデータの扱い

例：
「user_settingsテーブルのinitial_capitalカラムを
integer から numeric に変更してください。

現在のデータ: 約100件
理由: 小数点以下を扱えるようにしたい
変換: integer値はそのままnumericに変換可能
影響: データロスなし」
```

### 2. カラム名の変更

```
✅ リクエスト時に必ず含めること：
- 旧カラム名と新カラム名
- 影響を受けるコードの範囲
- フロントエンドでの使用箇所

例：
「tradesテーブルの"ticket"カラムを"trade_id"に変更してください。

影響範囲の確認：
1. TradesTableコンポーネント (src/components/TradesTable.tsx)
2. demoData.ts (src/services/demoData.ts)
3. CSVファイル (public/demo/*.csv)

すべてのコードとCSVファイルも合わせて更新してください。」
```

### 3. テーブルの削除

```
✅ リクエスト時に必ず含めること：
- 削除するテーブル名
- 現在のデータ件数
- 依存関係（外部キー等）
- バックアップの有無

例：
「import_historyテーブルを削除してください。

確認事項：
- 現在のデータ: 5件（テスト用のみ）
- 外部キー: なし
- 使用箇所: なし（未使用の機能）
- バックアップ: 不要（テストデータのみ）

削除前にデータを確認して、問題なければマイグレーションを作成してください。」
```

### 4. ユニーク制約の追加

```
✅ リクエスト時に必ず含めること：
- 対象カラム
- 既存データでの重複の有無
- 重複がある場合の対処方法

例：
「tradesテーブルに(user_id, ticket)の複合ユニーク制約を追加してください。

事前確認が必要：
1. 既存データで重複がないか確認
2. もし重複があれば、データをクリーンアップしてから制約追加

確認クエリ:
SELECT user_id, ticket, COUNT(*)
FROM trades
GROUP BY user_id, ticket
HAVING COUNT(*) > 1;

結果が0件なら制約を追加してください。」
```

---

## 📝 リクエストテンプレート

### テーブル作成

```markdown
## 新しいテーブルの作成

**目的**: [テーブルの目的を説明]

**テーブル名**: `table_name`

**カラム構成**:
- `id` (uuid, PK) - 主キー
- `user_id` (uuid, FK to auth.users) - ユーザーID
- `column1` (type, [NULL/NOT NULL]) - 説明
- `column2` (type, [NULL/NOT NULL]) - 説明
- `created_at` (timestamptz) - 作成日時
- `updated_at` (timestamptz) - 更新日時

**インデックス**:
- `user_id` にインデックス（頻繁に検索されるため）

**RLS**:
- SELECT: 自分のデータのみ参照可能
- INSERT: 自分のデータのみ作成可能
- UPDATE: 自分のデータのみ更新可能
- DELETE: 自分のデータのみ削除可能

**既存データへの影響**: なし
```

### カラム追加

```markdown
## カラムの追加

**テーブル**: `table_name`

**追加するカラム**:
- `column_name` (type)
- NULL: [許可/不許可]
- デフォルト値: [値 or NULL]
- 説明: [カラムの目的]

**既存データ**:
- 件数: 約[N]件
- 扱い: [NULLのまま / デフォルト値を設定 / 計算して設定]

**マイグレーション後の処理**: [あれば記載]
```

### RLSポリシー変更

```markdown
## RLSポリシーの変更

**テーブル**: `table_name`

**現在の状態**:
- [現在のポリシーを説明]

**変更後の状態**:
- [変更後のポリシーを説明]

**変更理由**:
- [なぜこの変更が必要か]

**セキュリティへの影響**:
- [セキュリティリスクの有無]
```

---

## 🚫 避けるべきリクエスト

### 1. 曖昧な指示

```
❌ 「データベースを最適化して」
❌ 「パフォーマンスを改善して」
❌ 「テーブルを修正して」
```

**問題点**: 何をどうすべきか不明確

**改善**: 具体的な目標と手段を指定
```
✅ 「tradesテーブルのopen_timeカラムにインデックスを追加して、
   日付範囲でのクエリを高速化してください。
   現在、500件のデータで約2秒かかっています。」
```

### 2. 複数の変更を一度に依頼

```
❌ 「テーブルを3つ追加して、既存の5つのテーブルにカラムを追加して、
   RLSも全部修正して」
```

**問題点**: エラーが起きたときの切り分けが困難

**改善**: 変更を小さく分割
```
✅ 「まず、trade_setupsテーブルを作成してください。
   その後、tradesテーブルにsetup_idカラムを追加します。」
```

### 3. デモデータをマイグレーションに含める依頼

```
❌ 「マイグレーションでデモデータを挿入して」
❌ 「データベースにテスト用の取引を追加して」
```

**問題点**: デモデータ管理のルールに違反

**改善**: CSVファイルで管理
```
✅ 「/public/demo/A.csv にトレードを追加してください。
   マイグレーションは不要です。」
```

---

## 🔍 変更前の確認事項

AIアシスタントに確認してもらうべきこと：

### 1. 既存データの確認

```
「変更前に以下を確認してください：
1. tradesテーブルの現在の件数
2. user_idがNULLのレコードの有無
3. 既存のインデックス一覧」
```

### 2. 依存関係の確認

```
「このテーブルを変更する前に、
以下の依存関係を確認してください：
1. 外部キー制約
2. 使用しているコンポーネント
3. 関連するRLSポリシー」
```

### 3. パフォーマンスへの影響

```
「この変更が以下に影響を与えるか確認してください：
1. クエリ速度
2. インデックスのサイズ
3. マイグレーション実行時間」
```

---

## 📊 変更後の検証依頼

マイグレーション適用後に確認してもらうこと：

### 1. スキーマ検証

```
「マイグレーション適用後、以下を確認してください：
1. テーブル構造が正しいか
2. RLSが有効になっているか
3. インデックスが作成されているか」
```

### 2. データ整合性

```
「変更後、以下のクエリを実行してデータを確認してください：
SELECT COUNT(*) FROM table_name;
SELECT * FROM table_name WHERE column IS NULL;」
```

### 3. アプリケーション動作

```
「変更後、以下の機能をテストしてください：
1. トレード一覧の表示
2. データのフィルタリング
3. 新規トレードの作成」
```

---

## 🎯 チェックリスト

データベース変更をリクエストする前に確認：

- [ ] 変更の目的を明確に説明したか
- [ ] 影響範囲を特定したか
- [ ] 既存データの扱いを決めたか
- [ ] マイグレーション/CSVのどちらで行うか明示したか
- [ ] RLSの要件を指定したか（新テーブルの場合）
- [ ] バックアップの必要性を確認したか
- [ ] 検証方法を指定したか

---

## 💡 ヒント

### データベース変更は小さく、頻繁に

```
❌ 大きな変更を一度に:
「5つのテーブルを追加して、10個のカラムを追加して...」

✅ 小さな変更を段階的に:
1. 「trade_setupsテーブルを作成」
2. マイグレーション適用、テスト
3. 「tradesにsetup_id追加」
4. マイグレーション適用、テスト
```

### 不明点は質問を促す

```
「tradesテーブルにステータスカラムを追加したいですが、
以下について推奨を教えてください：
1. ENUMとtext型のどちらが良いか
2. デフォルト値は何が適切か
3. 既存データはどう扱うべきか」
```

### ドキュメントを参照してもらう

```
「docs/DATABASE_RULES.mdに従って、
新しいテーブルを作成してください。
特にRLSのセキュリティルールを厳守してください。」
```

---

## 📚 関連ドキュメント

- [DATABASE_RULES.md](./DATABASE_RULES.md) - データベース管理の基本ルール
- [DEMO_DATA_MANAGEMENT.md](./DEMO_DATA_MANAGEMENT.md) - デモデータ管理ガイド
- [SECURITY_CRITICAL_FINDINGS.md](./SECURITY_CRITICAL_FINDINGS.md) - セキュリティ上の注意点

---

## 🤝 まとめ

### 効果的なリクエストの5原則

1. **具体的に** - 何をどうするか明確に
2. **理由を説明** - なぜその変更が必要か
3. **影響を考慮** - 既存データへの影響を明示
4. **小さく分割** - 複雑な変更は段階的に
5. **検証を依頼** - 変更後の確認方法を指定

これらを意識することで、安全で効率的なデータベース変更が可能になります。
